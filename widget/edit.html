<!-- Copyright start
  MIT License
  Copyright (c) 2024 Fortinet Inc
  Copyright end -->
<form data-ng-submit="save()" class="noMargin" name="editSankeyWidgetForm" data-ng-class="{'state-wait': processing }"
  novalidate>
  <div class="modal-header">
    <h3 class="modal-title col-md-9" data-ng-bind="::header"></h3>
    <button type="button" class="close" data-ng-click="cancel()" data-dismiss="modal" aria-label="Close"
      id="close-edit-widget-form-btn">
      <div aria-hidden="true" class="version-button">+</div>
    </button>
  </div>
  <div class="modal-body">
    <div>
      <div class="form-group"
        data-ng-class="{ 'has-error': editSankeyWidgetForm.title.$invalid && editSankeyWidgetForm.title.$touched }">
        <label for="title" class="control-label">Title<span class="text-danger">*</span></label>
        <input id="title" name="title" type="text" class="form-control" data-ng-model="config.title" required>
        <div data-cs-messages="editSankeyWidgetForm.title">
        </div>
      </div>
    </div>

    <label for="editSankeyWidgetForm" class="control-label">Data Source</label>
    <span class="text-danger">*
      <span
        data-uib-tooltip="Select the 'Record Containing JSON Data' option if all the records to be rendered are in a single record of a certain field of the module.
        'Count of Records Across Module' Dataset lets you select the module and it displays the count of records for the module based on the filters given"
        data-tooltip-append-to-body="true"><i class="icon icon-information font-Size-13"></i></span>
    </span>
    <!-- Radio Button -->

    <div class="row margin-bottom-sm">
      <div class="col-md-6 padding-right-0">
        <div class="radio">
          <label><input id="JsonField" name="JsonField" type="radio" data-ng-model="config.moduleType"
              data-ng-change="onChangeModuleType()" value="Single Module">&nbsp;&nbsp;Record Containing JSON
            Data</label>
          <span data-uib-tooltip="It allows you to select single record that contains a JSON object."
            data-tooltip-append-to-body="true"><i class="icon icon-information font-Size-13"></i></span>
        </div>
        <div class="radio">
          <label><input id="accrossModules" name="accrossModules" type="radio" data-ng-model="config.moduleType"
              data-ng-change="onChangeModuleType()" value="Across Modules">&nbsp;&nbsp;Get Live Data</label>
          <span data-uib-tooltip="It allows you to get live count." data-tooltip-append-to-body="true"><i
              class="icon icon-information font-Size-13"></i></span>
        </div>
      </div>
    </div>
    <!-- Radio Button End -->
    <!-- To fetch from single JSON Record -->
    <div data-ng-if="config.moduleType === 'Single Module'">
      <div class="form-group" data-ng-if="jsonObjModuleList"
        data-ng-class="{ 'has-error': editSankeyWidgetForm.customModule.$invalid && editSankeyWidgetForm.customModule.$touched }">
        <label for="customModule" class="control-label">JSON Data Source Modules
          <span class="text-danger">*</span>
        </label>
        <span data-uib-tooltip="Select the Module which has JSON data" data-tooltip-append-to-body="true"><i
            class="icon icon-information font-Size-13"></i></span>
        <select name="customModule" id="customModule" class="form-control"
          data-ng-options="module.type as module.name for module in jsonObjModuleList"
          data-ng-model="config.customModule" data-ng-change="loadAttributesForCustomModule(config.customModule)"
          required>
          <option value="">Select an Option</option>
        </select>
        <div data-cs-messages="editSankeyWidgetForm.customModule"></div>
      </div>
      <div class="form-group" data-ng-if="config.customModule">
        <div class="form-group" data-ng-if="objectFields.length > 0">
          <div for="customModuleField"
            data-ng-class="{ 'has-error': editSankeyWidgetForm.customModuleField.$invalid && editSankeyWidgetForm.customModuleField.$touched }">
            <label class="control-label">Select Field
              <span class="text-danger">*</span>
            </label>
            <span
              data-uib-tooltip="Select the Field which has the data, only json type fields will be available in the dropdown"
              data-tooltip-append-to-body="true"><i class="icon icon-information font-Size-13"></i></span>
            <select class="form-control" name="customModuleField" id="customModuleField"
              data-ng-options="field.name as field.title for field in objectFields"
              data-ng-model="config.customModuleField" required>
              <option value="">Select an Option</option>
            </select>
            <div data-cs-messages="editSankeyWidgetForm.customModuleField"></div>
          </div>
          <div for="filterJsonRecord" class="margin-top-md margin-bottom-md">
            <label class="control-label">Filter Record Which Contains The JSON Data
              <span class="text-danger">*</span>
            </label>
            <span
              data-uib-tooltip="This widget requires only one JSON record to work hence It is recommended to apply a filter, in case of multiple records first record will be assumed"
              data-tooltip-append-to-body="true"><i class="icon icon-information font-Size-13"></i></span>
            <div data-cs-conditional data-ng-if="fieldsArray.length > 0" data-fields="$parent.fields"
              data-reset-field="$parent.fields" data-mode="'queryFilters'" data-ng-model="$parent.config.query"
              data-parent-form="editSankeyWidgetForm" name="filterJsonRecord"
              data-enable-expression="(page==='dashboard' || page==='reporting')" data-show-uuid="true"
              data-form-name="'editSankeyWidgetForm'">
            </div>
            <div data-cs-messages="editSankeyWidgetForm.filterJsonRecord"></div>
          </div>
        </div>
        <div class="alert-danger alert margin-bottom-xlg margin-top-md" data-ng-if="objectFields.length == 0">
          <span>Select a module wich contains JSON field</span>
        </div>
      </div>
    </div>
    <!-- Live Data -->
    <div data-ng-if="config.moduleType === 'Across Modules'">
      <div class="mertics-widget-border padding-top-md padding-bottom-md"></div>
      <div class="form-group dashed-border-section" style="position:relative;" data-ng-repeat="item in config.layers">
        <div style="padding: 12px;">
          <div data-ng-if="$first">
            <div class="form-group"
              data-ng-class="{ 'has-error': editSankeyWidgetForm.resource.$invalid && editSankeyWidgetForm.resource.$touched }"
              data-ng-if="modules">
              <label for="resource" class="control-label">Resource<span class="text-danger">*</span></label>
              <select name="resource" id="resource" class="form-control"
                data-ng-options="module.type as module.name for module in modules" data-ng-model="config.resource"
                required data-ng-change="changeAttribute()">
                <option value="">Select an Option</option>
              </select>
              <div data-ng-if="!config.entityTrackable" class="cs-label">{{config.resource | uppercase}} is not
                trackable</div>
              <div data-cs-messages="editSankeyWidgetForm.resource"></div>
            </div>
            <div class="form-group" data-ng-if="config.resource">
              <label for="resource-filter" class="control-label">Filter Criteria</label>
              <div data-cs-conditional data-mode="'queryFilters'" name="resource-filter"
                data-fields="$parent.params.formFields" data-ng-model="$parent.config.query"
                data-form-name="'editSankeyWidgetForm'" data-parent-form="editSankeyWidgetForm"
                data-reset-field="$parent.params.formFields"></div>
            </div>
          </div>
          <div class="form-group" data-ng-if="config.resource">
            <label for="linkLabel-{{$index}}" class="control-label">Label<span class="text-danger">*</span></label>
            <input id="linkLabel-{{$index}}" name="linkLabel-{{$index}}" type="text" class="form-control"
              data-ng-model="item.label" required>
            <div data-cs-messages="editSankeyWidgetForm['linkLabel-'+$index]"></div>
          </div>
          <div class="form-group"
            data-ng-class="{ 'has-error': editSankeyWidgetForm['sourceNodesField-'+ $index].$invalid && editSankeyWidgetForm['sourceNodesField-'+ $index].$touched }"
            data-ng-if="config.resource && params.sourceNodeFields">
            <label for="sourceNodesField-{{$index}}" class="control-label">Source Nodes<span
                class="text-danger">*</span></label>
            <select name="sourceNodesField-{{$index}}" id="sourceNodesField-{{$index}}" class="form-control"
              data-ng-options="field.name as field.title for field in params.sourceNodeFields"
              data-ng-model="item.sourceNodesField" required data-ng-if="$first">
              <option value="">Select Source Nodes</option>
            </select>
            <div data-cs-messages="editSankeyWidgetForm['sourceNodesField-'+$index]" data-ng-if="$first"></div>
            <div data-ng-if="!$first">
              <label class="font-08em opacity-04">{{config.resource | uppercase}} -> <span
                  data-ng-if="!(config.layers[$index - 1].targetNodeSubField)">{{config.layers[$index -
                  1].targetNodeField | uppercase}}</span><span
                  data-ng-if="config.layers[$index - 1].targetNodeSubField"> LINKED {{config.layers[$index -
                  1].targetNodeField | uppercase}} -> {{config.layers[$index - 1].targetNodeSubField |
                  uppercase}}</span></label>
            </div>
          </div>
          <div class="form-group"
            data-ng-class="{ 'has-error': editSankeyWidgetForm['targetNodesField-'+ $index].$invalid && editSankeyWidgetForm['targetNodesField-'+ $index].$touched }"
            data-ng-if="config.resource && params.targetNodeFields">
            <label for="targetNodesField-{{$index}}" class="control-label">Target Nodes<span
                class="text-danger">*</span></label>
            <select name="targetNodesField-{{$index}}" id="targetNodesField-{{$index}}" class="form-control"
              data-ng-options="field.name as field.title for field in params.targetNodeFields"
              data-ng-change="onChangeTarget($index)" data-ng-model="item.targetNodeField" required>
              <option value="">Select Target Nodes</option>
            </select>
            <div data-cs-messages="editSankeyWidgetForm['targetNodesField-'+$index]"></div>
          </div>
          <div class="form-group"
            data-ng-class="{ 'has-error': editSankeyWidgetForm['targetNodesSubField-'+ $index].$invalid && editSankeyWidgetForm['targetNodesSubField-'+ $index].$touched }"
            data-ng-if="config.resource && params['targetNodesSubFields_'+$index].length>0">
            <label for="targetNodesSubFields-{{$index}}" class="control-label">Target Node Picklist<span
                class="text-danger">*</span></label>
            <select name="targetNodesSubFields-{{$index}}" id="targetNodesSubFields-{{$index}}" class="form-control"
              data-ng-options="field.name as field.title for field in params['targetNodesSubFields_'+$index]"
              data-ng-model="item.targetNodeSubField" data-ng-change="addSubTargetType($index)" required>
              <option value="">Select Picklist</option>
            </select>
            <div data-cs-messages="editSankeyWidgetForm['targetNodesSubField-'+$index]"></div>
          </div>
          <button type="button" data-ng-click="removeLayer($index)" id="removeLayer-{{ $index }}"
            class="btn-sm btn btn-link btn-conditional-delete" data-ng-if="$index !== 0"> <span
              class="icon icon-close text-danger"></span>
          </button>
        </div>
      </div>
      <div class="row margin-left-0 margin-top-lg margin-bottom-lg" style="padding-left: 5px;"
        data-ng-hide="processing || disabled || maxlayers || !config.resource">
        <button data-ng-click="addLayer()" type="button" class="btn btn-primary btn-xs">+&nbsp;Add Layer
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="edit-widget-save" type="submit" class="btn btn-sm btn-primary"><i
          class="icon icon-check margin-right-sm"></i>Save</button>
      <button id="edit-widget-cancel" type="button" class="btn btn-sm btn-default" data-ng-click="cancel()"><i
          class="icon icon-close margin-right-sm"></i>Close</button>
    </div>
</form>